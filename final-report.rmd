---
title: 'Final Project: COVID-19 Dataset'
author: 'The Lads: Frankie Willard, Manny Mokel, Alex Katopodis, Parker Dingman'
subtitle: Due Friday, November 20, 11:59 PM
output:
  pdf_document: default
  html_document: default
---

``` {r setup, warning = F, message = F, echo = F}

knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE)

library(tidyverse)

covid <- read_csv("data/covid-data.csv")

```

### Introduction
Throughout the year 2020, the COVID-19 pandemic took the world by storm, deeply impacting every country on the planet, albeit with differing degrees of severity. As cases continued to rise, families suffered from the loss of family members, jobs, social interactions, disposable income, and more. 

This public health crisis became severe enough such that many countries took decisive action, shutting down their economies to prioritize the lives of citizens. Meanwhile, other countries were less strict in their policies, attempting to preserve their economy at the potential expense of their citizen’s lives. The difference in each country’s characteristics, demographics, public health capacities, and the strictness of COVID-19 policies led to vastly different effects of the pandemic on different countries. Given our personal connections to the effects of the pandemic through our lives, our friends, and our families, we wanted to determine what led to the pandemic affecting some places worse than others.  

We are interested in investigating how a country's demographics impact the domestic severity of COVID-19. More specifically, we would like to see which demographics lead to higher cases per capita and deaths per case. We are also interested in analyzing how effective lockdowns and COVID-19 related policies have been in mitigating the spread of the virus.   

We hypothesize that stringency-index, GDP per capita, population density, and human development index will have a strong impact on cases per capita. We also hypothesize that deaths per case will be largely determined by GDP per capita, the number of citizens aged 65+, hospital beds per thousand, and prevalence of pre-existing conditions (ex. diabetes prevalence, cardiovascular death rate, etc.). Finally, we expect that strict COVID-19 policy has effectively slowed the transmission of the virus. 

These hypotheses are based on prior experiences and research. There is evidence that a high stringency index, a composite score based on how strict a country's restrictions are, slows the spread of COVID-19 [1]. We also know that patients with pre-existing conditions face a higher COVID-19 mortality rate [2, NEED A SOURCE!!!!!].  


### Data Description

We selected a data set from "Our World in Data." Each observation in the data set shows relevant COVID-19 data for a particular country on a given date. The COVID-19 data in the data set includes total deaths, total cases, new deaths, new cases, total cases per million, total deaths per million, total tests, new tests, total tests per thousand, positive rate, as well as telling country numbers such as stringency index (composite measure of government strictness policy) and hospital beds per thousand. Additionally, the data set includes country characteristics including population density, median age, GDP per capita, diabetes prevalence, life expectancy, and extreme poverty rate. While the previous variables are quantitative, the data set also includes categorical variables when it comes to geography such as the country and continent. 

“Our World In Data” uses data from the European Center for Disease Prevention and Control (ECDC), a world leader for COVID-19 data. The ECDC has a team of epidemiologists that works every day to screen up to 500 sources to get the latest figures. These sources include ministries of health (43%),  websites of public health institutes (9%),  websites of public health institutes (6%), World Health Organization (WHO) websites,  WHO situation reports (2%), and official dashboards and interactive maps from national and international institutions (10%). The EDEC also utilizes social media accounts maintained by national authorities, ministries of health, and official media outlets (30%). These social media sources are screened and validated by the other sources mentioned previously. The data is recorded daily, and we will be using the data set updated as of October 9, 2020 (10:30, London time).

We used latitude data from the website "Kaggle" to supplement the COVID-19 data set. This data was collected from a Google data set and was merged with the "Our World in Data" COVID-19 data set to create one larger data set.   

Here is a glimpse of our data set:

``` {r Glimpse}

glimpse(covid)

```
 
Sources:
https://ourworldindata.org/coronavirus-source-data
https://www.ecdc.europa.eu/en/covid-19/data-collection
https://www.kaggle.com/paultimothymooney/latitude-and-longitude-for-every-country-and-state


### Methodology
```{r Mutate Variables and Join}
covid <- covid %>%
  mutate(new_cases_per_cap = (new_cases/population),
         new_deaths_per_cap = (new_deaths/population),
         total_cases_per_cap = (total_cases/population),
         total_deaths_per_cap = (total_deaths/population))

covid_final_date <- covid %>% 
  mutate(stringency_index = if_else(is.na(stringency_index), 0, stringency_index)) %>%
  group_by(location) %>%
  mutate(median_si = median(stringency_index),
         total_cases_per_cap = total_cases / population) %>%
  filter(date == "2020-10-05" & !is.na(continent)) %>% 
  mutate(final_deaths_per_case = total_deaths/total_cases)

```

### Visualizations
In order to visualize the relationship between stringency index and the total cases per capita we created two world map plots. The first shows the median stringency index of a country throughout the entire pandemic while the second shows the total cases per capita on October 5th, 2020.

``` {r World Maps}

map_data <- covid_final_date %>%
  mutate(location = if_else(location == "United States", "USA", location)) %>%
  summarize(location, median_si, total_cases_per_cap,final_deaths_per_case)

map <- map_data("world")
covid_map <- left_join(map, map_data, by = c("region" = "location"))

ggplot(covid_map, mapping = aes(long, lat, group = group)) +
  coord_fixed(1.3) +
  geom_polygon(aes(fill = as.numeric(median_si)), color = "white") +
  scale_fill_gradient(low = "tomato", high = "seagreen1", name = "Median Stringency Index") +
  labs(title = "Median stringency index by country suggesting that most 
       countries have a median stringency index of about 60", x = "Longitude", y = "Latitude")

ggplot(covid_map, mapping = aes(long, lat, group = group)) +
  coord_fixed(1.3) +
  geom_polygon(aes(fill = total_cases_per_cap), color = "white") +
  scale_fill_gradient(low = "seagreen1", high = "tomato", name = "Total Cases per Capita") +
  labs(title = "Total cases per capita by country suggesting that total cases per capita 
       varies largely by continent", x = "Longitude", y = "Latitude")


```
While these visuals can help capture the big picture, it also is useful to see how stringency index impacts the growth of cases over time. To visualize this, we will plot several countries that have both relatively high and low total cases per capita. The growth of cases will be represented by the factor for which the new cases changed from the previous day.

``` {r Modifying the Data for Individual Plotting}

covid_stringency <- covid %>%
  filter(!is.na(new_cases)) %>%
  filter(!is.na(stringency_index))

covid_stringency$growth_new_cases <- 0


for (i in 2:nrow(covid_stringency)) {
  temp <- covid_stringency$new_cases[i] / covid_stringency$new_cases[i - 1]
  covid_stringency$growth_new_cases[i] <- if_else(is.finite(temp), temp, 1)
}


``` 

``` {r Plots of Individual Countries and their Stringency Indices / Case Growth Rate}
covid_stringency <- covid_stringency %>%
  select(location, date, new_cases, growth_new_cases, stringency_index)


plot_country <- function(x) {
  
  loc_data <- covid_stringency %>%
    filter(location == x)
  
  ggplot(data = loc_data, aes(x = date, y = stringency_index)) +
    geom_line() +
    labs(x = "Date",
       y = "Stringency Index",
       title = x) +
  ggplot(data = loc_data, aes(x = date, y = growth_new_cases)) +
    geom_line() +
    labs(x = "Date",
       y = "Rate of Spread of Covid-19") +
    geom_hline(yintercept = 1, color = "red")

}

plot_country("United States")
plot_country("Russia")
plot_country("Saudi Arabia")
plot_country("Brazil")
plot_country("China")
plot_country("Germany")

```

As is clear in all the graphs of individual countries, a high stringency index is associated with a lower volatility in the transmission rate of COVID-19. In the graphs of the US, Russia, and Saudi Arabia, this hold particularly true. There is a massive spike in cases during mid-March, which was roughly around the beginning of the first wave, and stringency index rises sharply. After stringency index rises, cases fall to a much lower growth rate. In the case of Brazil, China, and Germany, the graphs are a bit different. There are still major spikes around mid-March with stringency indexes going high almost immediately after. However, the transmission rates don't seem to flatten out nearly as much as they do in the US, Russia, and Saudi Arabia. There is still a good amount of volatility.



HYPOTHESIS: DEATHS PER CASE
```{r Deaths Per Case Map}

ggplot(covid_map, mapping = aes(long, lat, group = group)) +
  coord_fixed(1.3) +
  geom_polygon(aes(fill = final_deaths_per_case), color = "white") +
  scale_fill_gradient(low = "seagreen1", high = "tomato", 
                      name = "Total Deaths per Case") +
  labs(title = "Final Deaths Per Case per capita by country suggesting that
       deaths per case does not vary much by country except Yemen", 
       x = "Longitude", y = "Latitude")

```



```{r Visualize Deaths Per Case}

covid_deaths_case <- covid %>%
  mutate(deaths_per_case = total_deaths/total_cases) %>%
  group_by(date) %>%
  filter(!is.na(deaths_per_case)) %>%
  mutate(avg_deaths_case = mean(deaths_per_case),
         avg_total_case = mean(total_cases))

#Make title more informative
ggplot(data = covid_deaths_case, aes(x=date, y=avg_deaths_case)) +
  geom_line()+
  labs(x = "Date",
       y = "Deaths/Case",
       title = "Deaths Per Case Over Time")

```

```{r Visualize HDI vs Deaths/Case Over Time, warning = FALSE, message = FALSE, echo = FALSE}

#Could move this to exploratory data analysis


#Categories created based on 
# https://onlinelibrary.wiley.com/doi/full/10.1002/brb3.1755

covid <- covid %>% 
  mutate(hdi_columns = case_when(
    human_development_index >= 0.8 ~ "Very High",
    human_development_index < 0.8 & human_development_index >= 0.7 ~ "High",
    human_development_index < 0.7 & human_development_index >= 0.55 ~ "Medium",
    human_development_index < 0.55~ "Low"
  )) %>% 
  mutate(deaths_per_case = total_deaths/total_cases)

  
covid_deaths_hdi <- covid %>%
  group_by(hdi_columns, date) %>%
  filter(!is.na(deaths_per_case) & !is.na(human_development_index)) %>%
  mutate(avg_deaths_case = median(deaths_per_case))


#Can Facet Wrap:   facet_wrap(hdi_columns~.)+

#Make title more informative
ggplot(data = covid_deaths_hdi, aes(x=date, y=avg_deaths_case, 
                                    color = hdi_columns)) +
  geom_line()+
  labs(x = "Date",
       y = "Deaths/Case",
       title = "Mean Deaths Per Case Over Time",
       subtitle = "Color by Human Development Index Category")


```


```{r Aged Visualization}

covid <- covid %>% 
  mutate(aged_columns = case_when(
    aged_70_older >= 16 ~ "Very High",
    aged_70_older < 16 & aged_70_older >= 12 ~ "High",
    aged_70_older < 12 & aged_70_older >= 8 ~ "Medium",
    aged_70_older < 8 & aged_70_older >= 4 ~ "Low",
    aged_70_older < 4 & aged_70_older >= 0 ~ "Very Low"
  ))

covid_deaths_age <- covid %>%
  group_by(aged_columns, date) %>%
  filter(!is.na(deaths_per_case) & !is.na(aged_70_older)) %>%
  mutate(avg_deaths_case = median(deaths_per_case))


#Can Facet Wrap:   facet_wrap(hdi_columns~.)+

#Make title more informative
ggplot(data = covid_deaths_age, aes(x=date, y=avg_deaths_case, 
                                    color = aged_columns)) +
  geom_line()+
  labs(x = "Date",
       y = "Deaths/Case",
       title = "Mean Deaths Per Case Over Time",
       subtitle = "Color by Aged 70+ Category")

```



### Regressions
To assess which factors had the largest impact on determining a countries total cases per capita as well as test our hypothesis about total cases per capita, we will create a linear model to predict total cases per capita. We used the following linear model to try and predict total cases per capita based off of the demographics we hypothesized as well as a few additional variables. 
``` {r Cases Per Capita Regression}

lm_cpc <- lm(total_cases_per_cap ~ median_si + continent + gdp_per_capita + handwashing_facilities, data = covid_final_date)
lm_cpc %>%
 tidy() %>%
  arrange(p.value)

glance(lm_cpc) %>% 
  select(adj.r.squared, r.squared)

# Augmented Linear Model
m_aug <- augment(lm_cpc)

# Independence
ggplot(data = m_aug, 
       aes(x = 1:88, 
           y = .resid)) + 
  geom_point() + 
  labs(title = "Plot 1: Residuals in Order of the Dataset", 
       x = "Index", y = "Residual")

# Linearity and Equal Variance
ggplot(m_aug, mapping = aes(x = .fitted, y = .resid)) +
  geom_point() + 
  geom_hline(yintercept = 0, lwd = 2, col = "red", lty = 2) +
  labs(title = "Plot 2: PR Plot", x = "Predicted New Cases", y = "Residuals")

# Normality
ggplot(m_aug, mapping = aes(x= .resid)) +
  geom_histogram()

```


```{r Deaths Per Case Multiple Linear Regression, warning = FALSE, message = FALSE, echo = FALSE}

covid_deaths_reg <- covid %>%
  filter(date == "2020-10-05" & !is.na(continent)) %>%
  filter(!is.na(total_deaths) & !is.na(total_cases)) %>%
  mutate(final_deaths_per_case = total_deaths / total_cases) %>%
  select(final_deaths_per_case, cardiovasc_death_rate,-contains("case") & -contains("death") & -contains("test")) %>%
  select(-iso_code, -continent, -location, -date, -positive_rate) %>%
  filter_all(all_vars(!is.na(.)))

m_main <- lm(final_deaths_per_case ~ diabetes_prevalence + aged_70_older  + female_smokers + human_development_index + gdp_per_capita + life_expectancy + cardiovasc_death_rate + handwashing_facilities, data = covid_deaths_reg)

m_main %>%
 tidy() %>% 
  arrange(desc(p.value))

glance(m_main) %>%
  select(r.squared, adj.r.squared)

```

### Chi-Squared
Our visualizations and linear models suggested there might be some sort of relationship between total cases per capita and continent. In the visualization of total cases per capita on the world map, it appeared that continents seemed to have similar total cases per capita. In the linear model predicting total cases per capita, we observed that certain continent predictor weights were statistically significant. Thus, we will test for independence between total cases per capita and continent. We will do so using a chi-squared test at the $\alpha$ = 0.05 significance level.

$H_0$: There is independence between continent and total cases per capita.

$H_0$: There is NOT independence between continent and total cases per capita.

``` {r Chi-Squared Continent and CPC}

covid_tcpc <- covid %>%
  filter(!is.na(total_cases_per_cap) & !is.na(continent))

chisq.test(table(covid_tcpc$continent, covid_tcpc$total_cases_per_cap))

```



### Results




### Discussion


### References

[1] https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7418951/#:~:text=Our%20model%20implies%20that%20social,at%2021%20days%20after%20implementation.
[2]
[3]


